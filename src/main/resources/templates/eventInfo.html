<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
	<head>
	    <title>Información del Evento</title>
	    <meta charset="UTF-8">
		<link rel="stylesheet" href="/css/styles.css">
	    <!-- Bootstrap CDN -->
	    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
		
		<!-- Leaflet CSS y JS -->
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
		<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

		<!-- Leaflet Control Geocoder CSS y JS -->
		<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
		<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
	
	    <style>
	        #map {
	            height: 300px;
	            margin-bottom: 1rem;
	        }
		</style>
	</head>
	<body>
		<!-- Nav Menu -->
        <div th:replace="~{fragments/navMenu :: navMenu}"></div>
			
		<div class="container mt-5">
			<!-- Información general -->
			<div style="display: flex; gap: 2rem; margin-bottom: 2rem;">
			  <!-- Imagen del evento a la izquierda -->
			  <div style="flex: 1;">
			    <img th:src="@{'/img/event/' + ${event.imagen}}" 
			         alt="Imagen del evento" 
			         style="width: 100%; max-width: 500px; height: auto; border-radius: 1rem;">
			  </div>

			  <!-- Información a la derecha -->
			  <div style="flex: 1;">
			    <h1 th:text="${event.title}">Título del evento</h1>
			    <p><strong>Fecha:</strong><span th:text="${event.startDate}"></span> a <span th:text="${event.endDate}"></span></p>
			    <p><strong>Descripción:</strong></p>
			    <p th:text="${event.description}">Descripción aquí</p>
				<p><strong>Aforo</strong>
					<span th:text="${event.numParticipants}"></span>
					/
					<span th:text="${event.maxCapacity}"></span></p>

				<!-- Ubicación en texto -->
				<p><strong>Lugar:</strong> <span th:text="${event.ubication}" id="ubication-text">Burgos, Castilla y León, España</span></p>

				<!-- Ubicación con pin en el mapa -->
				<div id="map"></div>
				
				<div class="my-3">
					<p><strong>Categorías:</strong> 
				    <span class="badge bg-primary" th:each="cat : ${event.categories}" th:text="${cat.category.name}">Sin categoría</span>
				</div>
			  </div>
			</div>

			 <!-- Para Participantes -->
			<div sec:authorize="hasRole('PARTICIPANTE')">
			  <h2>Actividades</h2>
			  <ul>
			    <li th:each="activity : ${event.activities}" th:text="${activity.name}">Nombre de actividad</li>
			  </ul>
			</div>
		   
		    <div sec:authorize="hasRole('PARTICIPANTE')">
		        <div th:if="${!event.participants.contains(user)}">
		            <form th:action="@{/event/join/{id}(id=${event.id})}" method="post">
		                <button type="submit" class="btn btn-success">Inscribirse</button>
		            </form>
		        </div>
		        <div th:if="${event.participants.contains(user)}">
					<form th:action="@{/event/leave/{id}(id=${event.id})}" method="post">
		                <button type="submit" class="btn btn-success">Desinscibirse</button>
		            </form>
		        </div>
		    </div>
		
		    <!-- Para Organizadores -->
		    <div sec:authorize="hasRole('ORGANIZADOR')" th:if="${owner}">
		
		        <h3 class="mt-4">Gestión del Evento</h3>
		
		        <a th:href="@{/event/edit/{id}(id=${event.id})}" class="btn btn-warning mb-3">Editar evento</a>
		
		        <h4>Participantes inscritos:</h4>
		        <ul class="list-group mb-4">
					<li class="list-group-item" th:if="${#lists.isEmpty(event.participants)}">No hay participantes actualmente</li>
		            <li class="list-group-item" th:each="participant : ${event.participants}" th:text="${participant.username}">Usuario</li>
		        </ul>
		
		        <h4>Actividades</h4>
		        <ul class="list-group">
		            <li class="list-group-item" th:each="activity : ${event.activities}">
		                <strong th:text="${activity.name}">Nombre</strong> - 
		                <span th:text="${activity.description}">Descripción</span>
		            </li>
		        </ul>
		        <a th:href="@{/activity/manage/{id}(id=${event.id})}" class="btn btn-secondary mt-3">Gestionar Actividades</a>
		    </div>
		</div>
		
		<script>
			// Cuando carga el DOM carga la ubicación en el mapa
			document.addEventListener("DOMContentLoaded", function () {
				// Se extrae la ubicación del texto
			    const address = document.getElementById("ubication-text").textContent.trim();
			    const map = L.map('map').setView([40, -3], 6);

			    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			        attribution: '© OpenStreetMap contributors'
			    }).addTo(map);

			    // API de Nominatim para decodificar ubicación
			    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=es&limit=1`)
			        .then(response => response.json())
			        .then(data => {
			            if (data && data.length > 0) {
			                const result = data[0];
			                const lat = parseFloat(result.lat);
			                const lon = parseFloat(result.lon);
			                map.setView([lat, lon], 13);
							
							// Añade el pin en el mapa
			                L.marker([lat, lon])
			                    .addTo(map)
			                    .bindPopup(address) 
			                    .openPopup();
			            } else {
			                throw new Error('Ubicación no encontrada');
			            }
			        }) // Gestión de errores (algunas direcciones no salen en el mapa, en algunos paises va muy mal...)
			        .catch(error => {
			            console.error("Error en geocodificación:", error);
						// En caso de no encontrar la ubicación se muestra este mensaje de error dentro del mapa
			            document.getElementById('map').innerHTML = `
			                <div class="alert alert-warning">
			                    No se pudo cargar la ubicación: ${address}
			                </div>
			            `;
			        });

			    setTimeout(() => map.invalidateSize(), 100);
			});
		</script>
	</body>
</html>
